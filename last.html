<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
    <meta charset="UTF-8">
    <!-- CRITICAL: viewport-fit=cover ve user-scalable=no, iOS Safari'de tam ekran deneyimi sağlar -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Archive - Modern ZIP Preview Studio</title>
    
    <!-- Meta Tags -->
    <meta name="title" content="Archive - ZIP Preview Studio">
    <meta name="description" content="Next-gen ZIP file viewer. Preview React, HTML, code & images instantly. 100% Client-side.">
    <!-- Safari Status Bar Rengi (Header ile uyumlu olması için dinamik) -->
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#09090b" media="(prefers-color-scheme: dark)">
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Archive">

    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- Prism Code Highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">

    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        border: "hsl(var(--border))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                    },
                    height: {
                        'screen-dvh': '100dvh',
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 240 10% 3.9%;
            --border: 240 5.9% 90%;
            /* Safe area değişkenlerini tanımlıyoruz ama global padding olarak kullanmıyoruz */
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --background: 240 10% 3.9%;
                --foreground: 0 0% 98%;
                --border: 240 3.7% 15.9%;
            }
        }

        /* IOS FIX: html ve body'yi fixed yaparak scroll bounce'u engelliyoruz.
           100dvh sayesinde adres çubuğu açılıp kapansa da tam oturur.
        */
        html, body {
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            position: fixed; /* iOS'te sayfanın kaymasını engeller */
            inset: 0;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            -webkit-tap-highlight-color: transparent;
        }

        /* App Root: Flex column düzeni */
        #app-root {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            /* Padding vermiyoruz, iç elemanlar safe-area'yı yönetecek */
        }

        /* Header: Safe area top kadar padding alır */
        header {
            padding-top: var(--safe-top);
            height: calc(3.5rem + var(--safe-top));
            padding-left: max(1rem, var(--safe-left));
            padding-right: max(1rem, var(--safe-right));
        }

        /* Sidebar & Main: Alt kısımlar safe area bottom kadar padding alır */
        .safe-bottom-padding {
            padding-bottom: var(--safe-bottom);
        }
        
        .safe-left-padding {
            padding-left: var(--safe-left);
        }

        /* Syntax Highlighting */
        pre[class*="language-"] {
            margin: 0 !important;
            border-radius: 0 !important;
            height: 100%;
            background: #09090b !important;
        }

        /* Scrollbar improvements */
        .custom-scroll {
            -webkit-overflow-scrolling: touch;
        }
        .custom-scroll::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: rgba(128, 128, 128, 0.2);
            border-radius: 10px;
        }

        /* Loader Animation */
        .spinner {
            border: 2px solid rgba(255,255,255,0.1);
            border-left-color: currentColor;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* File Tree Animation */
        .folder-content {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.2s ease-out;
        }
        .folder-content.open {
            grid-template-rows: 1fr;
        }
        .folder-inner {
            overflow: hidden;
        }
    </style>
</head>
<body>

    <!-- Drag Drop Overlay -->
    <div id="drop-zone" class="fixed inset-0 z-[100] bg-blue-500/10 backdrop-blur-sm hidden flex-col items-center justify-center border-4 border-blue-500 border-dashed m-4 rounded-3xl pointer-events-none">
        <i data-lucide="download" class="w-16 h-16 text-blue-500 mb-4 animate-bounce"></i>
        <p class="text-2xl font-bold text-blue-500">Drop ZIP here</p>
    </div>

    <!-- App Root -->
    <div id="app-root">
        
        <!-- Header -->
        <header class="flex items-center justify-between border-b border-zinc-200 dark:border-zinc-800 shrink-0 bg-white dark:bg-zinc-950 z-20 transition-colors duration-200">
            <div class="flex items-center gap-3 h-14 w-full">
                <button id="menu-btn" class="md:hidden p-2 -ml-2 rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-800 active:scale-95 transition-transform">
                    <i data-lucide="menu" class="w-5 h-5"></i>
                </button>
                <div class="flex items-center gap-2 font-bold text-lg tracking-tight select-none cursor-pointer" onclick="window.location.reload()">
                    <div class="w-8 h-8 bg-black dark:bg-white text-white dark:text-black rounded-lg flex items-center justify-center">
                        <i data-lucide="archive" class="w-4 h-4"></i>
                    </div>
                    <span class="hidden sm:block">Archive</span>
                </div>

                <div class="flex items-center gap-2 ml-auto">
                    <!-- Static Toggle -->
                    <div id="static-toggle-container" class="hidden items-center gap-2 mr-2 bg-zinc-100 dark:bg-zinc-900 px-2 py-1 rounded-md">
                        <span class="text-[10px] font-semibold uppercase text-zinc-500">Static</span>
                        <button id="static-toggle" class="w-8 h-4 bg-zinc-300 dark:bg-zinc-700 rounded-full relative transition-colors" aria-pressed="false">
                            <div class="w-4 h-4 bg-white rounded-full shadow-sm absolute top-0 left-0 transition-transform scale-90"></div>
                        </button>
                    </div>

                    <input type="file" id="zip-input" class="hidden" accept=".zip,.rar,.7z">
                    <label for="zip-input" class="cursor-pointer bg-black hover:bg-zinc-800 dark:bg-white dark:hover:bg-zinc-200 text-white dark:text-black px-4 py-2 rounded-full text-sm font-medium transition-transform active:scale-95 flex items-center gap-2 shadow-sm whitespace-nowrap">
                        <i data-lucide="upload-cloud" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Open ZIP</span>
                        <span class="sm:hidden">Open</span>
                    </label>
                </div>
            </div>
        </header>

        <!-- Main Layout (Flex Row) -->
        <div class="flex flex-1 relative overflow-hidden">
            
            <!-- Sidebar -->
            <aside id="sidebar" class="absolute md:relative z-30 w-72 h-full bg-zinc-50/95 dark:bg-zinc-950/95 backdrop-blur-xl border-r border-zinc-200 dark:border-zinc-800 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-[cubic-bezier(0.32,0.72,0,1)] flex flex-col safe-left-padding">
                <div class="p-4 border-b border-zinc-200 dark:border-zinc-800 flex items-center justify-between shrink-0 h-12">
                    <span class="text-xs font-semibold text-zinc-500 uppercase tracking-wider">Explorer</span>
                    <span id="file-count" class="text-xs text-zinc-400">0 items</span>
                </div>
                
                <!-- File Tree -->
                <div id="file-tree" class="flex-1 overflow-y-auto custom-scroll p-2 select-none safe-bottom-padding">
                    <!-- Empty State -->
                    <div class="h-full flex flex-col items-center justify-center text-center p-6 text-zinc-400">
                        <i data-lucide="folder-dashed" class="w-10 h-10 mb-3 opacity-20"></i>
                        <p class="text-sm">No project loaded</p>
                    </div>
                </div>
            </aside>

            <!-- Backdrop -->
            <div id="sidebar-backdrop" class="absolute inset-0 bg-black/50 z-20 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300 md:hidden"></div>

            <!-- Content Area -->
            <main class="flex-1 relative bg-white dark:bg-zinc-900 overflow-hidden flex flex-col w-full min-w-0">
                
                <!-- View Tabs (Hidden by default) -->
                <div id="view-tabs" class="h-10 border-b border-zinc-200 dark:border-zinc-800 flex bg-white dark:bg-zinc-950 shrink-0 hidden">
                    <button class="view-tab active flex-1 md:flex-none px-6 text-sm font-medium border-b-2 border-black dark:border-white text-black dark:text-white transition-colors" data-view="preview">Preview</button>
                    <button class="view-tab flex-1 md:flex-none px-6 text-sm font-medium border-b-2 border-transparent text-zinc-500 hover:text-zinc-800 dark:hover:text-zinc-300 transition-colors" data-view="code">Code</button>
                </div>

                <!-- Dynamic Content Container -->
                <div class="relative flex-1 w-full overflow-hidden bg-zinc-100 dark:bg-black">
                    
                    <!-- Landing Hero -->
                    <div id="landing-hero" class="absolute inset-0 flex flex-col items-center justify-center p-6 text-center z-10 bg-white dark:bg-zinc-950 safe-bottom-padding overflow-y-auto custom-scroll">
                        <div class="max-w-md w-full flex flex-col items-center">
                            <div class="w-16 h-16 bg-gradient-to-tr from-zinc-200 to-zinc-100 dark:from-zinc-800 dark:to-zinc-900 rounded-2xl flex items-center justify-center mb-6 shadow-xl shadow-zinc-200/50 dark:shadow-none ring-1 ring-zinc-900/5 dark:ring-white/10">
                                <i data-lucide="package" class="w-8 h-8 text-zinc-800 dark:text-zinc-200"></i>
                            </div>
                            <h1 class="text-3xl font-bold mb-3 tracking-tight text-zinc-900 dark:text-zinc-50">Archive Studio</h1>
                            <p class="text-zinc-500 dark:text-zinc-400 mb-8 leading-relaxed">
                                Preview React builds, static sites, and code files instantly. Secure, client-side, and edge-to-edge optimized.
                            </p>
                            
                            <div class="flex flex-wrap gap-2 justify-center text-xs font-mono text-zinc-400">
                                <span class="bg-zinc-100 dark:bg-zinc-900 px-2 py-1 rounded border border-zinc-200 dark:border-zinc-800">.zip</span>
                                <span class="bg-zinc-100 dark:bg-zinc-900 px-2 py-1 rounded border border-zinc-200 dark:border-zinc-800">.html</span>
                                <span class="bg-zinc-100 dark:bg-zinc-900 px-2 py-1 rounded border border-zinc-200 dark:border-zinc-800">.jsx</span>
                            </div>
                            
                            <div class="mt-8 pt-8 border-t border-zinc-200 dark:border-zinc-800 w-full flex justify-center gap-6 text-zinc-400">
                                <div class="flex flex-col items-center gap-1">
                                    <i data-lucide="shield-check" class="w-5 h-5"></i>
                                    <span class="text-[10px]">Private</span>
                                </div>
                                <div class="flex flex-col items-center gap-1">
                                    <i data-lucide="zap" class="w-5 h-5"></i>
                                    <span class="text-[10px]">Fast</span>
                                </div>
                                <div class="flex flex-col items-center gap-1">
                                    <i data-lucide="smartphone" class="w-5 h-5"></i>
                                    <span class="text-[10px]">Mobile</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Loader -->
                    <div id="loader" class="absolute inset-0 bg-white/80 dark:bg-black/80 backdrop-blur z-50 hidden flex flex-col items-center justify-center">
                        <div class="spinner text-black dark:text-white mb-3"></div>
                        <p id="loader-text" class="text-sm font-medium animate-pulse text-zinc-600 dark:text-zinc-400">Processing...</p>
                    </div>

                    <!-- Iframe Preview -->
                    <div id="preview-container" class="absolute inset-0 w-full h-full bg-white hidden">
                        <!-- IMPORTANT: iframe takes 100% height, safe-area handled by content inside iframe or user interaction -->
                        <iframe id="preview-frame" class="w-full h-full border-0" sandbox="allow-scripts allow-same-origin allow-forms allow-modals allow-downloads"></iframe>
                    </div>

                    <!-- Code Viewer -->
                    <div id="code-container" class="absolute inset-0 w-full h-full overflow-hidden hidden bg-[#09090b]">
                        <!-- safe-bottom-padding added to container -->
                        <div class="h-full w-full overflow-auto custom-scroll safe-bottom-padding">
                            <pre class="min-h-full p-4 text-sm font-mono"><code id="code-block" class="language-javascript"></code></pre>
                        </div>
                    </div>

                    <!-- Image Preview -->
                    <div id="image-container" class="absolute inset-0 w-full h-full flex items-center justify-center hidden p-4 safe-bottom-padding overflow-auto">
                        <img id="image-preview" class="max-w-full max-h-full object-contain drop-shadow-2xl rounded-lg">
                    </div>

                </div>
            </main>
        </div>
        
        <!-- Toast -->
        <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-[calc(var(--safe-bottom)+20px)] bg-zinc-900/90 dark:bg-zinc-100/90 backdrop-blur text-white dark:text-black px-4 py-3 rounded-xl shadow-2xl flex items-center gap-3 transition-all duration-300 translate-y-24 opacity-0 z-[60] pointer-events-none">
            <i id="toast-icon" data-lucide="info" class="w-4 h-4"></i>
            <span id="toast-msg" class="text-sm font-medium">Notification</span>
        </div>

    </div>

    <script>
        const App = {
            state: {
                zip: null,
                files: {},
                activeFile: null,
                blobUrls: [],
                isStaticMode: false,
                htmlCache: new Map()
            },

            ui: {
                fileTree: document.getElementById('file-tree'),
                previewFrame: document.getElementById('preview-frame'),
                codeBlock: document.getElementById('code-block'),
                sidebar: document.getElementById('sidebar'),
                landing: document.getElementById('landing-hero'),
                tabs: document.getElementById('view-tabs')
            },

            init() {
                this.bindEvents();
                lucide.createIcons();
                
                // Prevent iOS bounce globally
                document.body.addEventListener('touchmove', function(e) {
                    // This is a rough fix, in a real app you might need more specific targeting
                    // Only prevent default if target isn't scrollable
                    // For now, reliance on 'position: fixed' body handles most of it.
                }, { passive: false });
            },

            bindEvents() {
                // File Input
                document.getElementById('zip-input').addEventListener('change', (e) => {
                    if (e.target.files.length) this.loadZip(e.target.files[0]);
                });

                // Drag & Drop
                const dropZone = document.getElementById('drop-zone');
                let dragCounter = 0;

                document.body.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    dragCounter++;
                    dropZone.classList.remove('hidden');
                    dropZone.classList.add('flex');
                });
                
                document.body.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dragCounter--;
                    if (dragCounter === 0) {
                        dropZone.classList.remove('flex');
                        dropZone.classList.add('hidden');
                    }
                });
                
                document.body.addEventListener('dragover', (e) => e.preventDefault());
                
                document.body.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dragCounter = 0;
                    dropZone.classList.add('hidden');
                    dropZone.classList.remove('flex');
                    if (e.dataTransfer.files.length) {
                        const file = e.dataTransfer.files[0];
                        if (file.name.toLowerCase().endsWith('.zip')) this.loadZip(file);
                        else this.toast('Please upload a ZIP file', 'alert-circle');
                    }
                });

                // Mobile Sidebar
                const backdrop = document.getElementById('sidebar-backdrop');
                const toggleSidebar = () => {
                    const isOpen = !this.ui.sidebar.classList.contains('-translate-x-full');
                    if (isOpen) {
                        this.ui.sidebar.classList.add('-translate-x-full');
                        backdrop.classList.remove('opacity-100', 'pointer-events-auto');
                        backdrop.classList.add('opacity-0', 'pointer-events-none');
                    } else {
                        this.ui.sidebar.classList.remove('-translate-x-full');
                        backdrop.classList.remove('opacity-0', 'pointer-events-none');
                        backdrop.classList.add('opacity-100', 'pointer-events-auto');
                    }
                };
                
                document.getElementById('menu-btn').addEventListener('click', toggleSidebar);
                backdrop.addEventListener('click', toggleSidebar);

                // View Tabs
                document.querySelectorAll('.view-tab').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.switchView(btn.dataset.view);
                        document.querySelectorAll('.view-tab').forEach(b => {
                            b.classList.remove('active', 'border-black', 'dark:border-white', 'text-black', 'dark:text-white');
                            b.classList.add('border-transparent', 'text-zinc-500');
                        });
                        btn.classList.add('active', 'border-black', 'dark:border-white', 'text-black', 'dark:text-white');
                        btn.classList.remove('border-transparent', 'text-zinc-500');
                    });
                });

                // Static Mode Toggle
                const staticToggleBtn = document.getElementById('static-toggle');
                staticToggleBtn.addEventListener('click', () => {
                    this.state.isStaticMode = !this.state.isStaticMode;
                    const indicator = staticToggleBtn.querySelector('div');
                    
                    if (this.state.isStaticMode) {
                        staticToggleBtn.classList.replace('bg-zinc-300', 'bg-green-500');
                        staticToggleBtn.classList.replace('dark:bg-zinc-700', 'dark:bg-green-500');
                        indicator.classList.add('translate-x-4');
                        this.toast('Static Mode: Scripts Disabled', 'shield');
                    } else {
                        staticToggleBtn.classList.replace('bg-green-500', 'bg-zinc-300');
                        staticToggleBtn.classList.replace('dark:bg-green-500', 'dark:bg-zinc-700');
                        indicator.classList.remove('translate-x-4');
                        this.toast('Dynamic Mode: Scripts Enabled', 'zap');
                    }

                    if (this.state.activeFile && this.state.activeFile.name.endsWith('.html')) {
                        this.state.htmlCache.clear();
                        this.openFile(this.state.activeFile);
                    }
                });
            },

            async loadZip(file) {
                this.setLoader(true, 'Extracting ZIP...');
                this.cleanup();
                
                try {
                    const zip = await JSZip.loadAsync(file);
                    this.state.zip = zip;
                    this.state.files = zip.files;
                    
                    this.renderFileTree();
                    this.ui.landing.classList.add('hidden');
                    
                    const indexFile = Object.values(zip.files).find(f => 
                        !f.dir && (f.name.toLowerCase().endsWith('index.html') || f.name.toLowerCase() === 'index.htm')
                    );
                    
                    if (indexFile) {
                        await this.openFile(indexFile);
                    } else {
                        const firstFile = Object.values(zip.files).find(f => !f.dir);
                        if (firstFile) await this.openFile(firstFile);
                    }

                    const count = Object.keys(zip.files).filter(k => !zip.files[k].dir).length;
                    document.getElementById('file-count').textContent = `${count} items`;
                    this.toast('Project loaded successfully', 'check-circle');

                } catch (err) {
                    console.error(err);
                    this.toast('Failed to load ZIP', 'alert-triangle');
                } finally {
                    this.setLoader(false);
                }
            },

            renderFileTree() {
                const tree = {};
                
                Object.keys(this.state.files).forEach(path => {
                    // Remove leading slash if exists
                    const cleanPath = path.startsWith('/') ? path.slice(1) : path;
                    const parts = cleanPath.split('/');
                    let current = tree;
                    parts.forEach((part, i) => {
                        if (!part) return;
                        if (!current[part]) {
                            current[part] = (i === parts.length - 1 && !this.state.files[path].dir) 
                                ? { __file: this.state.files[path] } 
                                : {};
                        }
                        current = current[part];
                    });
                });

                const buildDom = (node, path = '') => {
                    const ul = document.createElement('ul');
                    ul.className = 'pl-3 border-l border-zinc-200/50 dark:border-zinc-800/50 ml-1.5';
                    
                    const keys = Object.keys(node).sort((a, b) => {
                        const aIsFile = !!node[a].__file;
                        const bIsFile = !!node[b].__file;
                        if (aIsFile === bIsFile) return a.localeCompare(b);
                        return aIsFile ? 1 : -1;
                    });

                    keys.forEach(key => {
                        const item = node[key];
                        const li = document.createElement('li');
                        li.className = 'my-0.5';

                        if (item.__file) {
                            const btn = document.createElement('button');
                            btn.className = 'w-full text-left flex items-center gap-2 px-2 py-1.5 rounded-md hover:bg-zinc-200/50 dark:hover:bg-zinc-800/50 text-[13px] text-zinc-600 dark:text-zinc-400 truncate transition-colors file-btn select-none';
                            
                            let icon = 'file';
                            const lowerKey = key.toLowerCase();
                            if (lowerKey.endsWith('.html')) icon = 'code-2';
                            else if (lowerKey.match(/\.(js|ts|jsx|tsx)$/)) icon = 'file-code';
                            else if (lowerKey.match(/\.(css|scss|less)$/)) icon = 'palette';
                            else if (lowerKey.match(/\.(png|jpg|jpeg|gif|svg|webp)$/)) icon = 'image';
                            else if (lowerKey.match(/\.(json|xml|yaml)$/)) icon = 'file-json';
                            
                            btn.innerHTML = `<i data-lucide="${icon}" class="w-3.5 h-3.5 opacity-70 flex-shrink-0"></i> <span class="truncate">${key}</span>`;
                            btn.onclick = () => {
                                document.querySelectorAll('.file-btn').forEach(b => b.classList.remove('bg-zinc-200', 'dark:bg-zinc-800', 'text-black', 'dark:text-white', 'font-medium'));
                                btn.classList.add('bg-zinc-200', 'dark:bg-zinc-800', 'text-black', 'dark:text-white', 'font-medium');
                                this.openFile(item.__file);
                                
                                if (window.innerWidth < 768) {
                                    document.getElementById('menu-btn').click();
                                }
                            };
                            li.appendChild(btn);
                        } else {
                            const wrapper = document.createElement('div');
                            
                            const header = document.createElement('button');
                            header.className = 'w-full text-left flex items-center gap-2 px-2 py-1.5 rounded-md hover:bg-zinc-100 dark:hover:bg-zinc-800/30 text-[13px] font-medium text-zinc-800 dark:text-zinc-200 transition-colors select-none';
                            header.innerHTML = `
                                <i data-lucide="chevron-right" class="w-3.5 h-3.5 transition-transform duration-200 text-zinc-400"></i>
                                <i data-lucide="folder" class="w-3.5 h-3.5 text-blue-500/80 dark:text-blue-400/80"></i>
                                <span class="truncate">${key}</span>
                            `;
                            
                            const content = document.createElement('div');
                            content.className = 'folder-content';
                            const inner = document.createElement('div');
                            inner.className = 'folder-inner';
                            
                            inner.appendChild(buildDom(item, path + key + '/'));
                            content.appendChild(inner);

                            header.onclick = () => {
                                const isOpen = content.classList.toggle('open');
                                header.querySelector('[data-lucide="chevron-right"]').style.transform = isOpen ? 'rotate(90deg)' : 'rotate(0deg)';
                                header.querySelector('[data-lucide="folder"]').setAttribute('data-lucide', isOpen ? 'folder-open' : 'folder');
                                lucide.createIcons();
                            };

                            wrapper.appendChild(header);
                            wrapper.appendChild(content);
                            li.appendChild(wrapper);
                            
                            if (path === '') header.click(); 
                        }
                        ul.appendChild(li);
                    });
                    return ul;
                };

                this.ui.fileTree.innerHTML = '';
                const rootUl = buildDom(tree);
                rootUl.classList.remove('border-l', 'pl-3', 'ml-1.5'); // Clean root styles
                this.ui.fileTree.appendChild(rootUl);
                lucide.createIcons();
            },

            async openFile(file) {
                this.state.activeFile = file;
                const ext = file.name.split('.').pop().toLowerCase();
                const isImage = ['png', 'jpg', 'jpeg', 'gif', 'svg', 'webp'].includes(ext);
                const isHtml = ext === 'html' || ext === 'htm';
                
                const toggleContainer = document.getElementById('static-toggle-container');
                const tabs = document.getElementById('view-tabs');
                
                if (isHtml) {
                    toggleContainer.classList.remove('hidden');
                    toggleContainer.classList.add('flex');
                    tabs.classList.remove('hidden');
                } else {
                    toggleContainer.classList.add('hidden');
                    toggleContainer.classList.remove('flex');
                    if (!isImage) tabs.classList.remove('hidden');
                    else tabs.classList.add('hidden');
                }

                this.setLoader(true, 'Reading file...');

                try {
                    if (isImage) {
                        const blob = await file.async('blob');
                        const url = URL.createObjectURL(blob);
                        this.state.blobUrls.push(url);
                        document.getElementById('image-preview').src = url;
                        this.switchView('image');
                    } else {
                        const text = await file.async('string');
                        
                        this.ui.codeBlock.textContent = text;
                        // Map extensions to Prism languages if needed, otherwise use simple fallback
                        const prismLang = ext === 'js' || ext === 'jsx' ? 'javascript' : 
                                          ext === 'ts' || ext === 'tsx' ? 'typescript' : 
                                          ext === 'html' ? 'markup' : 
                                          ext;
                        this.ui.codeBlock.className = `language-${prismLang}`;
                        Prism.highlightElement(this.ui.codeBlock);

                        if (isHtml) {
                            await this.processAndPreviewHtml(file, text);
                            this.switchView('preview');
                            document.querySelector('[data-view="preview"]').click();
                        } else {
                            this.switchView('code');
                            if(!tabs.classList.contains('hidden')) {
                                document.querySelector('[data-view="code"]').click();
                            }
                        }
                    }
                } catch (e) {
                    console.error(e);
                    this.toast('Error reading file', 'x-circle');
                } finally {
                    this.setLoader(false);
                }
            },

            async processAndPreviewHtml(file, htmlContent) {
                const cacheKey = file.name + (this.state.isStaticMode ? '_static' : '_dynamic');
                if (this.state.htmlCache.has(cacheKey)) {
                    this.ui.previewFrame.src = this.state.htmlCache.get(cacheKey);
                    return;
                }

                this.setLoader(true, 'Processing assets...');

                let processedHtml = htmlContent;
                // Simple folder resolution logic
                // If file is "folder/sub/index.html", folderPath is "folder/sub"
                const lastSlash = file.name.lastIndexOf('/');
                const folderPath = lastSlash !== -1 ? file.name.substring(0, lastSlash) : '';
                
                // Matches src="...", href="...", content="..." (meta images), poster="..."
                const regex = /(src|href|poster|content)="([^"]+)"/g;
                const matches = [...htmlContent.matchAll(regex)];
                
                const processBatch = async () => {
                   for (const match of matches) {
                        const attr = match[1];
                        const relativePath = match[2];
                        
                        if (relativePath.match(/^(http|https|data:|blob:|#|mailto:|tel:)/)) continue;

                        // Resolve Path
                        let absolutePath = '';
                        if (relativePath.startsWith('/')) {
                            // Absolute path from zip root
                            absolutePath = relativePath.slice(1);
                        } else {
                            // Relative path
                            const parts = (folderPath ? folderPath + '/' : '') + relativePath;
                            // Basic normalization for ../
                            const stack = [];
                            parts.split('/').forEach(p => {
                                if (p === '..') stack.pop();
                                else if (p !== '.') stack.push(p);
                            });
                            absolutePath = stack.join('/');
                        }

                        // Try to find file
                        const linkedFile = this.state.files[absolutePath];
                        if (linkedFile) {
                            try {
                                const blob = await linkedFile.async('blob');
                                let mime = 'application/octet-stream';
                                const linkExt = absolutePath.split('.').pop().toLowerCase();
                                if (linkExt === 'css') mime = 'text/css';
                                else if (linkExt === 'js') mime = 'application/javascript';
                                else if (['png','jpg','jpeg','gif','svg','webp'].includes(linkExt)) mime = `image/${linkExt === 'svg' ? 'svg+xml' : linkExt}`;
                                
                                const blobUrl = URL.createObjectURL(new Blob([blob], { type: mime }));
                                this.state.blobUrls.push(blobUrl);
                                
                                // Replace ALL occurrences of this path to be safe
                                processedHtml = processedHtml.split(relativePath).join(blobUrl);
                            } catch(e) { console.warn('Failed to load asset', absolutePath); }
                        }
                    }
                }
                
                await processBatch();

                if (this.state.isStaticMode) {
                    processedHtml = processedHtml.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, "");
                    const banner = `<div style="background:#22c55e;color:white;padding:6px;text-align:center;font-family:system-ui;font-size:12px;font-weight:600;position:fixed;top:0;left:0;right:0;z-index:9999;">Static Preview Mode</div><div style="height:28px"></div>`;
                    if(processedHtml.includes('<body')) {
                        processedHtml = processedHtml.replace(/<body[^>]*>/, `$&${banner}`);
                    } else {
                        processedHtml = banner + processedHtml;
                    }
                }

                // Add base for relative links if needed, but blob url replacement handles most
                // Inject script to catch errors if dynamic
                if (!this.state.isStaticMode) {
                   const errScript = `<script>window.onerror = function(msg, url, line) { console.error("Preview Error:", msg); };<\/script>`;
                   processedHtml = processedHtml.replace('<head>', `<head>${errScript}`);
                }

                const finalBlob = new Blob([processedHtml], { type: 'text/html' });
                const finalUrl = URL.createObjectURL(finalBlob);
                this.state.blobUrls.push(finalUrl);
                this.state.htmlCache.set(cacheKey, finalUrl);

                this.ui.previewFrame.src = finalUrl;
            },

            switchView(viewName) {
                document.getElementById('preview-container').classList.add('hidden');
                document.getElementById('code-container').classList.add('hidden');
                document.getElementById('image-container').classList.add('hidden');

                if (viewName === 'preview') document.getElementById('preview-container').classList.remove('hidden');
                else if (viewName === 'code') document.getElementById('code-container').classList.remove('hidden');
                else if (viewName === 'image') document.getElementById('image-container').classList.remove('hidden');
            },

            setLoader(active, text = 'Loading...') {
                const el = document.getElementById('loader');
                document.getElementById('loader-text').textContent = text;
                if (active) el.classList.remove('hidden');
                else el.classList.add('hidden');
            },

            toast(msg, iconName = 'info') {
                const el = document.getElementById('toast');
                document.getElementById('toast-msg').textContent = msg;
                document.getElementById('toast-icon').setAttribute('data-lucide', iconName);
                lucide.createIcons();
                
                el.classList.remove('translate-y-24', 'opacity-0');
                
                clearTimeout(this.toastTimeout);
                this.toastTimeout = setTimeout(() => {
                    el.classList.add('translate-y-24', 'opacity-0');
                }, 3000);
            },

            cleanup() {
                this.state.blobUrls.forEach(url => URL.revokeObjectURL(url));
                this.state.blobUrls = [];
                this.state.htmlCache.clear();
                this.ui.previewFrame.src = 'about:blank';
                this.ui.codeBlock.textContent = '';
                document.getElementById('image-preview').src = '';
            }
        };

        window.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>
</html>


